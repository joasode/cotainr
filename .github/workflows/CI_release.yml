name: CI for release

on:
  workflow_dispatch:
  release:
    types: [released]

jobs:
  build:
    name: Build package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv build .
      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

  publish-to-testpypi:
    needs: build
    name: Publish to TestPyPI
    # only publish to TestPyPI on tag pushes and successful test workflow
    runs-on: ubuntu-latest

    environment:
      name: testpypi
      url: https://test.pypi.org/p/cotainr

    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing

    steps:
    - uses: actions/checkout@v4  # Checkout because `uv publish` requires pyproject.toml
    - name: Download all the dists
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist
    - name: Set up uv
      uses: astral-sh/setup-uv@v5
    - name: Publish distribution to TestPyPI
      run: echo 'Simulate uv publish --index testpypi'
    #  run: uv publish --index testpypi

  test-testpypi:
    name: Test TestPyPI Build
    needs: publish-to-testpypi
    runs-on: ubuntu-latest

    steps:
    - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

    - name: Set up uv
      uses: astral-sh/setup-uv@v5

    - name: Test TestPyPI build
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install cotainr=${{ github.ref_name }} --index https://test.pypi.org/simple/
        uv pip install 'cotainr[tests]' # Get Pytest from real PyPI distribution
	cotainr info
	cotainr build --help

  publish-to-pypi:
    needs: test-testpypi
    runs-on: ubuntu-latest

    environment:
      name: pypi
      url: https://pypi.org/p/cotainr

    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing

    steps:
    - uses: actions/checkout@v4  # Checkout because `uv publish` requires pyproject.toml
    - name: Download all the dists
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist
    - name: Set up uv
      uses: astral-sh/setup-uv@v5
    - name: Publish distribution to PyPI
      run: echo 'Simulate uv publish'
    #   run: uv publish
